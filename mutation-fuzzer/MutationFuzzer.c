#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/wait.h>
#include <unistd.h>

/*Main fuction*/
int main(void){ 
	FILE *inputFile, *outputFile;
    
    char inputBuffer[2000];    
    char outputBuffer[20];	
	
	int responseCode, sysResponse;
	static char responseBuffer[100];

	char imageCrashed[40];
	char commandExec[200];

	int time = 0, crashCounter = 0 ;

	int readBytes;
	int bugNumber;
	int bug1 = 0, bug2 = 0, bug3 = 0, bug4 = 0, bug5 = 0, bug6 = 0, bug7 = 0, bug8 = 0;

	int mutations = 2000;
	

	for(int index = 1; index <= mutations; index++ ){

		inputFile = fopen("./cross.jpg", "rb");
		outputFile = fopen("./test.jpg", "wb");

		fseek(inputFile, 0, SEEK_END);
		readBytes = ftell(inputFile);
		fseek(inputFile,0,SEEK_SET);
		fread(inputBuffer,1,readBytes,inputFile);

		if(index%48 == 0){
			inputBuffer[index] = rand()%10+1;
		}
		else{
			int buffer = (rand() % 808);
			inputBuffer[buffer] = rand() % 800;
		}

		fwrite(inputBuffer,1,readBytes,outputFile);
		fclose(inputFile);
		fclose(outputFile);

		sprintf(commandExec,"./jpg2bmp test.jpg test.bmp");
		sysResponse = system(commandExec);

		wait(&time);

		responseCode = WEXITSTATUS(sysResponse);

		if(responseCode==128+11 || responseCode ==128+6)
		{
			FILE *outputProcess = popen("./jpg2bmp test.jpg test.bmp 2>&1", "r");

			while(fgets(responseBuffer, sizeof(responseBuffer), outputProcess) != NULL)
			break;
			pclose(outputProcess);

			if(responseBuffer[0] == 'B' && responseBuffer[1] == 'u' && responseBuffer[2] == 'g'){
				bugNumber = atoi(&responseBuffer[5]);
			

			switch(bugNumber)
			{
				case 1: bug1++;
				break;

				case 2: bug2++;
				break;

				case 3: bug3++;
				break; 

				case 4: bug4++;
				break;

				case 5: bug5++;
				break;

				case 6: bug6++;
				break; 
			
				case 7: bug7++;
				break;

				case 8: bug8++;
				break;
			}

			sprintf(outputBuffer,"./test-%d.jpg",bugNumber);
			outputFile = fopen(outputBuffer,"wb");
			fwrite(inputBuffer,1,readBytes,outputFile);
			fclose(outputFile);
			}

		crashCounter = crashCounter + 1;
        sprintf(imageCrashed,"./crashed-%d.jpg",crashCounter);
		fprintf(stderr,"crashed image : %s\n",imageCrashed);
		
       outputFile=fopen(imageCrashed, "wb");
       fwrite (inputBuffer,1,readBytes,outputFile);
        fclose(outputFile);

	}
}

	printf("\n Number of segmentation faults: %d\n",crashCounter);
	printf(" Bug1 occurrences: %d\n", bug1 );
	printf(" Bug2 occurrences: %d\n", bug2 );
	printf(" Bug3 occurrences: %d\n", bug3 ); 
	printf(" Bug4 occurrences: %d\n", bug4 );
	printf(" Bug5 occurrences: %d\n", bug5 );
	printf(" Bug6 occurrences: %d\n", bug6 );
	printf(" Bug7 occurrences: %d\n", bug7 );
	printf(" Bug8 occurrences: %d\n", bug8 );

	return 0;
}
